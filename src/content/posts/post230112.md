---
title: '三次握手四次挥手'
pubDate: 2023-01-12 12:00:00
description: ''
author: 'Cafe_Killer'
image:
    url: ''
    alt: ''
tags: ["网络", "面试"]
class: '技术'
draft: false
---

很老套，似乎每个程序员都要写一遍 TCP 三次握手四次挥手的文章，这个知识点其实很久之前我也学习过，也写过了。不过最近准备出去找工作了，虽然这个知识点很基础，几乎只要和网络沾点边的同学都知道起码也是都了解的。但都说**最基础的才是最容易翻车的**，想来也是，自己虽然知道，但是确实没有牢记下来，闲来无事，就写吧希望这次能记住。

# 三次握手

建立一个 TCP 连接需要「三次握手」，缺一不可：

- **一次握手**: 客户端发送带有 `SYN（SEQ=x）` 标志的数据包 -> 服务端，然后客户端进入 `SYN_SEND` 状态，等待服务端的确认；
- **二次握手**: 服务端发送带有 `SYN+ACK(SEQ=y,ACK=x+1)` 标志的数据包 –> 客户端,然后服务端进入 `SYN_RECV` 状态；
- **三次握手**: 客户端发送带有 `ACK(ACK=y+1)` 标志的数据包 –> 服务端，然后客户端和服务端都进入 `ESTABLISHED` 状态，完成 TCP 三次握手。

完成以上步骤就可以正常传输数据进行通信了。

## 半连接队列与全连接队列

在 TCP 三次握手过程中，Linux 内核会维护两个队列来管理连接请求：

- 半连接队列(SYN Queue)：当服务端收到客户端的 SYN 请求时，此时双方还没有完全建立连接，它会把半连接状态的连接放在半连接队列。
- 全连接队列(Accept Queue)：当服务端收到客户端对 ACK 响应时，意味着三次握手成功完成，服务端会将该连接从半连接队列移动到全连接队列。如果未收到客户端的 ACK 响应，会进行重传，重传的等待时间通常是指数增长的。如果重传次数超过系统规定的最大重传次数，系统将从半连接队列中删除该连接信息。

这两个队列的存在是为了处理并发连接请求，确保服务端能够有效地管理新的连接请求。另外，新的连接请求被拒绝或忽略除了和每个队列的大小限制有关系之外，还和很多其他因素有关系，这里就不详细介绍了，整体逻辑比较复杂。

## 为何是三次握手

三次握手的目的是建立可靠的通信信道，说到通讯，简单来说就是数据的发送与接收，而三次握手最主要的目的就是双方确认自己与对方的发送与接收是正常的。

**第一次握手**：Client 什么都不能确认；Server 确认了对方发送正常，自己接收正常

**第二次握手**：Client 确认了自己发送、接收正常，对方发送、接收正常；Server 确认了对方发送正常，自己接收正常

**第三次握手**：Client 确认了自己发送、接收正常，对方发送、接收正常；Server 确认了自己发送、接收正常，对方发送、接收正常

*三次握手就能确认双方收发功能都正常，缺一不可。*

## 携带数据

在 TCP 三次握手过程中，第三次握手是可以携带数据的<small-text>（客户端发送完 ACK 确认包之后就进入 ESTABLISHED 状态了）</small-text>，这一点在 RFC 793 文档中有提到。也就是说，一旦完成了前两次握手，TCP 协议允许数据在第三次握手时开始传输。

如果第三次握手的 ACK 确认包丢失，但是客户端已经开始发送携带数据的包，那么服务端在收到这个携带数据的包时，如果该包中包含了 ACK 标记，服务端会将其视为有效的第三次握手确认。这样，连接就被认为是建立的，服务端会处理该数据包，并继续正常的数据传输流程。

# 四次挥手

断开一个 TCP 连接则需要“四次挥手”，缺一不可：

- **第一次挥手**：客户端发送一个 `FIN（SEQ=x）` 标志的数据包->服务端，用来关闭客户端到服务端的数据传送。然后客户端进入 `FIN-WAIT-1` 状态。
- **第二次挥手**：服务端收到这个 `FIN（SEQ=X）` 标志的数据包，它发送一个 `ACK （ACK=x+1）`标志的数据包 -> 客户端 。然后服务端进入 `CLOSE-WAIT` 状态，客户端进入 `FIN-WAIT-2` 状态。
- **第三次挥手**：服务端发送一个 `FIN (SEQ=y)` 标志的数据包->客户端，请求关闭连接，然后服务端进入 `LAST-ACK` 状态。
- **第四次挥手**：客户端发送 `ACK (ACK=y+1)` 标志的数据包->服务端，然后客户端进入TIME-WAIT状态，服务端在收到 `ACK (ACK=y+1)` 标志的数据包后进入 `CLOSE` 状态。此时如果客户端等待 2MSL 后依然没有收到回复，就证明服务端已正常关闭，随后客户端也可以关闭连接了。

只要四次挥手没有结束，客户端和服务端就可以继续传输数据！

