---
title: '浏览器网页性能优化'
pubDate: 2023-04-18 12:00:00
description: '前端页面作为用户对接的主要入口，除了要求那些精美的设计和交互效果，性能优化也一样非常的重要'
author: 'CafeKiller'
image:
    url: ''
    alt: ''
tags: ["前端"]
class: '技术'
---

# 重排重绘

浏览器渲染引擎是浏览器的核心组成部分之一，它负责将页面代码转换为可视化的内容。  
浏览器渲染大致分为四个阶段，解析 HTML 和 CSS、构建 DOM 树和 CSSOM 树并最终合成 Render 树、根据渲染树计算元素位置、最后根渲染树和计算后的布局信息，将元素合成绘制到屏幕上。

在渲染的过程中，浏览器是会自行进行各类优化的，从而提高渲染速度和效率。例如：浏览器会尽可能地并行加载和解析 HTML、CSS、JavaScript 文件，以减少等待速度。同时还会配合缓存、预加载等技术来提高网页的渲染效率。

不过如果 DOM 或 CSSOM 被修改会导致浏览器重复执行上面提到的四个渲染步骤，所谓重排重绘其本质就是指触发了 **布局** 和 **渲染** 这两步骤。

> 当页面的元素的位置、尺寸等发生改变时，浏览器会重新计算该元素的几何属性并摆放到正确的位置的过程叫做重排。一般页面初次渲染、带有动画的元素、添加或删除功能、图片放大缩小、浏览器改变时都可能会触发重排。重排和回流其实是一回事，**重排也叫回流**。

**引发重排重绘的常见操作**

- 页面外观有直接变化时，会导致重绘，比如修改 `color`、`opacity`等。
- 布局结构或者节点内容发生变化时，会导致重排，比如修改 `height`、`float`、`position`等。
  - 盒子尺寸或类型；
  - 定位方案（正常流、浮动和绝对定位）；
  - 文档树中元素之间的关系；
  - 外部信息变更（视口大小变化、横竖屏切换）。
- 获取布局信息，会导致重排。相关方法如：`offsetTop`、`getComputedStyle`等。

目前主流显示器的刷新率至少都有 60FPS。理想情况下，浏览器需要在 1/60 秒内完成渲染阶段并交付一帧到显示器，这样才能让用户看见一个交互流畅的页面。  
在交互阶段，页面的更新通常会触发重排重绘。为了提升浏览器网页的渲染效率，应当尽可能减少重绘重，从而降低浏览器渲染耗费的时间，将内容尽快渲染到屏幕上。

**处理重排重绘的常见方案**

1. 对 DOM 进行批量写入或读取操作，如通过虚拟 DOM 或者 DocumentFragment 实现。
2. 避免样式的频繁操作，了解[样式触发机制](https://csstriggers.com/)，合理使用样式。
3. 多使用特殊样式属性，如 `will-change`、`transform`、`filter`，将渲染层提升为合成层，开启GPU加速、提高页面性能。
4. 使用变量对布局信息进行缓存，避免 JavaScript 代码因频繁读取布局信息而触发重排重绘。
5. 同时建议使用浏览器自带的 DevTools Performance 工具来查看重排重绘任务占用主线的情况。

# 移动H5前端优化

PC 上的优化手段同样是适用于手机端的，在移动端上我们应该尽量保证能在三秒内渲染完成首屏指标，同时要保证影响首屏加载和渲染的代码应当在处理逻辑中后置。

**加载优化**

加载过程是最为耗时的过程，可能会占到总耗时的80%时间，因此是H5优化的重中之重。

减少HTTP请求，一些浏览器同时响应请求是有限制的<small-text>（目前限制的具体数量由各家浏览器决定，有多有少）</small-text>，所以应当尽量减少HTTP请求，常见操作就是合并压缩 CSS 和 JavaScript 文件，对小尺寸图片进行合并，使用雪碧图（精灵图）；  
避免重定向，重定向会影响加载速度，所以在服务器正确设置避免重定向；  
异步加载第三方资源，第三方资源不可控会影响页面的加载和显示，因此要异步加载第三方资源；  
减少 cookie，cookie 较多会影响到加载速度，如果是静态资源域名建议不使用 cookie；  
预加载，部分游戏类的界面资源普遍比较大且重，过长的加载时间会导致用户流失，此时推荐使用预加载，如：可感知的 Loading 界面、不可感知的 Loading（提前加载下个场景的资源）；  


**CSS优化**

应当尽量避免写在 HTML 标签中写 style 属性。  
避免 CSS表达式，CSS表达式的执行需跳出 CSS树的渲染，因此请避免 CSS表达式；  
移除空的CSS规则，空的CSS规则增加了CSS文件的大小，且影响CSS树的执行，所以需移除空的 CSS 规则；  
不滥用浮动，float 在渲染时计算量比较大，尽量减少使用；  
不滥用 Web 字体，Web 字体需要下载，解析，重绘当前页面，尽量减少使用；  
不声明过多的 font-size，过多的 font-size 引发CSS树的效率；  
值为 0 时不需要任何单位，为了浏览器的兼容性和性能，值为 0 时不要带单位；  
标准化各种浏览器前缀，如：无前缀应放在最后、CSS动画只用 `-webkit-` `无前缀` 两种即可、其它前缀为 `-webkit-` `-moz-` `-ms-` `无前缀` 四种 <small-text>（-o- Opera浏览器改用 blink 内核，所以淘汰）</small-text>  
避免让选择符看起来像正则表达式，高级选择器执行耗时相对较长且不易读懂，避免使用；  
无阻塞，写在HTML头部的JavaScript（无异步），和写在HTML标签中的Style会阻塞页面的渲染，因此CSS放在页面头部并使用Link方式引入，避免在HTML标签中写Style，JavaScript放在页面尾部或使用异步方式加载。  

**JavaScript执行优化**

减少重绘和回流，避免不必要的 dom 操作、尽量改变 class 而不是 style，使用 classList 代替 className、避免使用 document.write 、减少 drawImage；  
缓存 dom 选择与计算，dom 选择都会触发计算，应避免重复计算；  
缓存列表 .length，每次 .length 都要计算，用一个变量保存这个值；  
尽量使用事件代理，避免批量绑定事件；  
尽量使用ID选择器，ID选择器是所有选择器中最快的； 
事件优化，使用 touchstart、touchend 代替 click，因快影响速度快。但应注意 Touch 响应过快，易引发误操作。

**渲染优化**

HTML 使用 viewport，viewport 可以加速页面的渲染，请使用：`<meta name=”viewport” content=”width=device-width, initial-scale=1″>`  
减少 dom 节点，dom 节点太多影响页面的渲染，应尽量减少 dom 节点；  
动画优化，尽量使用 CSS3 动画、使用 requestAnimationFrame 监听帧变化，使得在正确的时间进行渲染、增加响应变化的时间间隔，减少重绘次数；  
GPU加速，CSS 中有不少属性能够触发 GPU 渲染，可以合理使用<small-text>（过度使用会导致设备过热）</small-text>，如：transitions、transforms、opacity、canvas、WebGL、Video。

# 参考

- [什么是重排或回流、重绘？如何减少重排？](https://segmentfault.com/a/1190000044671367)
- [深入理解浏览器的重绘与重排](https://zhuanlan.zhihu.com/p/148825597)
- [移动H5前端性能优化指南](https://mp.weixin.qq.com/s/rMm8u6QM5O4dFClLEcXc3A)